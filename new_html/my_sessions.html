<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>My Sessions - SkillSwap</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' },
                        dark: { bg: '#0F1115', surface: '#161B22', border: '#252B36' }
                    }
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        
        .nav-link.active { background-color: #eff6ff; color: #2563eb; }
        .dark .nav-link.active { background-color: rgba(37, 99, 235, 0.2); color: #60a5fa; }
        .filled { font-variation-settings: 'FILL' 1; }
    </style>
</head>
<body class="bg-[#F8FAFC] dark:bg-dark-bg text-slate-800 dark:text-slate-200 h-screen flex overflow-hidden selection:bg-brand-500/30">

    <aside class="hidden md:flex w-72 flex-col bg-white dark:bg-dark-surface border-r border-slate-200 dark:border-dark-border z-20 shrink-0 h-screen sticky top-0">
        <div class="h-20 flex items-center px-8 border-b border-slate-100 dark:border-dark-border cursor-pointer" onclick="window.location.href='landing_page.html'">
            <div class="flex items-center gap-3 text-brand-600 dark:text-brand-500 font-black text-2xl tracking-tighter">
                <span class="material-symbols-rounded text-3xl">all_inclusive</span> SkillSwap
            </div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
            <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-2">Main Menu</p>
            <a href="user_dashboard.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">dashboard</span> Dashboard
            </a>
            <a href="my_sessions.html" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-2xl font-bold transition-all">
                <span class="material-symbols-rounded">calendar_month</span> My Sessions
            </a>
            <a href="skill_search.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">manage_search</span> Find Skills
            </a>
            
            <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Community & Growth</p>
            <a href="community.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">groups</span> Community
            </a>
            <a href="leaderboard.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">leaderboard</span> Leaderboard
            </a>

            <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Personal</p>
            <a href="payment&reward_sys.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">account_balance_wallet</span> Wallet
            </a>
            <a href="user_profile.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">person</span> My Profile
            </a>
            <a href="settings.html" class="nav-link flex items-center gap-3 px-4 py-3 rounded-2xl font-medium text-slate-500 hover:bg-slate-50 dark:hover:bg-white/5 transition-all">
                <span class="material-symbols-rounded">settings</span> Settings
            </a>
        </nav>
        <div class="p-6 border-t border-slate-100 dark:border-dark-border">
            <button onclick="window.location.href='teach_skill.html'" class="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white rounded-2xl font-bold shadow-lg shadow-brand-500/30 hover:shadow-brand-500/50 transition-all flex items-center justify-center gap-2 group">
                <span class="material-symbols-rounded group-hover:rotate-12 transition-transform">school</span> Teach Now
            </button>
        </div>
    </aside>

    <div id="mobile-sidebar" class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-dark-surface z-50 transform -translate-x-full md:hidden flex flex-col border-r border-slate-200 dark:border-dark-border shadow-2xl transition-transform duration-300">
        <div class="h-20 flex items-center justify-between px-6 border-b border-slate-100 dark:border-dark-border">
            <span class="font-black text-xl text-brand-600">SkillSwap</span>
            <button onclick="toggleMobileMenu()" class="text-slate-500"><span class="material-symbols-rounded">close</span></button>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
            <a href="user_dashboard.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Dashboard</a>
            <a href="my_sessions.html" class="block px-4 py-3 rounded-xl font-bold text-brand-600 bg-brand-50">My Sessions</a>
            <a href="skill_search.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Find Skills</a>
            <a href="community.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Community</a>
            <a href="leaderboard.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Leaderboard</a>
            <a href="payment&reward_sys.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Wallet</a>
            <a href="user_profile.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Profile</a>
            <a href="settings.html" class="block px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">Settings</a>
        </nav>
    </div>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-[#F8FAFC] dark:bg-dark-bg">
        
        <header class="h-20 flex items-center justify-between px-8 z-20 sticky top-0 w-full shrink-0 border-b border-slate-200 dark:border-white/5 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-md">
            <div class="flex items-center gap-4 md:hidden">
                <button onclick="toggleMobileMenu()" class="text-slate-500"><span class="material-symbols-rounded">menu</span></button>
                <span class="font-bold text-lg">My Sessions</span>
            </div>
            
            <div class="hidden md:flex relative w-96 group"></div>

            <div class="flex items-center gap-5">
                <button id="logout-btn" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Logout">
                    <span class="material-symbols-rounded">logout</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-12">
            <div class="max-w-6xl mx-auto space-y-8">
                
                <div class="flex gap-6 border-b border-slate-200 dark:border-white/10">
                    <button onclick="switchTab('learning')" id="tab-learning" class="pb-3 border-b-2 border-brand-600 text-brand-600 font-bold text-sm transition-colors">Learning (Student)</button>
                    <button onclick="switchTab('teaching')" id="tab-teaching" class="pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-bold text-sm transition-colors">Teaching (Mentor)</button>
                </div>

                <div id="learning-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

                <div id="teaching-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>

            </div>
        </div>
    </main>

    <div id="review-modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex justify-center items-center p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-[32px] shadow-2xl p-8 border dark:border-white/10 transform scale-95 opacity-0 transition-all duration-300" id="review-content">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-black text-slate-900 dark:text-white">Rate Session</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">How was your experience with the mentor?</p>
            </div>

            <div class="flex justify-center gap-3 mb-6">
                <button onclick="rate(1)" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"><span class="material-symbols-rounded text-4xl">star</span></button>
                <button onclick="rate(2)" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"><span class="material-symbols-rounded text-4xl">star</span></button>
                <button onclick="rate(3)" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"><span class="material-symbols-rounded text-4xl">star</span></button>
                <button onclick="rate(4)" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"><span class="material-symbols-rounded text-4xl">star</span></button>
                <button onclick="rate(5)" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"><span class="material-symbols-rounded text-4xl">star</span></button>
            </div>

            <textarea id="review-comment" rows="3" class="w-full bg-slate-50 dark:bg-black/20 border-none rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 dark:text-white resize-none font-medium text-sm mb-6" placeholder="Write a brief comment..."></textarea>

            <div class="flex gap-3">
                <button onclick="closeReviewModal()" class="flex-1 py-3 font-bold text-slate-500 hover:bg-slate-50 rounded-xl transition-colors">Cancel</button>
                <button onclick="submitReview()" id="submit-review-btn" class="flex-[2] py-3 bg-brand-600 text-white rounded-xl font-bold shadow-lg shadow-brand-500/30 hover:bg-brand-700 transition-all">Submit</button>
            </div>
        </div>
    </div>

    <script>
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        let myId = null;
        let currentReview = { bookingId: null, teacherId: null, rating: 0 };

        document.addEventListener('DOMContentLoaded', async () => {
            myId = localStorage.getItem('skillswap_temp_userid');
            if (!myId) { window.location.href = 'login.html'; return; }
            
            await loadSessions();
        });

        async function loadSessions() {
            try {
                const res = await fetch(`http://127.0.0.1:5000/api/bookings/user/${myId}`);
                const bookings = await res.json();
                
                const learningContainer = document.getElementById('learning-container');
                const teachingContainer = document.getElementById('teaching-container');
                
                learningContainer.innerHTML = '';
                teachingContainer.innerHTML = '';

                if (bookings.length === 0) {
                    learningContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-10 opacity-50">
                            <span class="material-symbols-rounded text-4xl mb-2 text-slate-400">calendar_today</span>
                            <p class="font-bold text-slate-400">No sessions found.</p>
                        </div>`;
                    return;
                }

                // Sort by date (newest first)
                bookings.sort((a, b) => new Date(b.date) - new Date(a.date));

                bookings.forEach(b => {
                    const isTeacher = (b.teacherId === myId);
                    const otherName = isTeacher ? b.learnerName : b.teacherName;
                    const roleLabel = isTeacher ? "Student" : "Mentor";
                    const statusStyle = getStatusStyle(b.status);

                    let actionBtn = "";
                    
                    // 1. Teacher: Accept/Decline
                    if (isTeacher && b.status === 'pending') {
                        actionBtn = `
                            <div class="flex gap-2 mt-4 pt-4 border-t border-slate-100 dark:border-white/5">
                                <button onclick="updateStatus('${b._id}', 'confirmed')" class="flex-1 bg-green-500 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-green-600 shadow-lg shadow-green-500/20 transition-all">Accept</button>
                                <button onclick="updateStatus('${b._id}', 'cancelled')" class="flex-1 bg-slate-100 text-slate-600 dark:bg-white/10 dark:text-white py-2.5 rounded-xl text-xs font-bold hover:bg-red-50 hover:text-red-500 transition-all">Decline</button>
                            </div>`;
                    } 
                    // 2. Active Session: Join
                    else if (b.status === 'confirmed' || b.status === 'ready' || b.status === 'ongoing') {
                        actionBtn = `
                            <button onclick="joinSession('${b._id}', '${isTeacher ? 'teacher' : 'learner'}')" class="mt-4 w-full bg-brand-600 text-white py-3 rounded-xl text-xs font-bold shadow-lg shadow-brand-500/20 hover:scale-[1.02] transition-all flex justify-center items-center gap-2">
                                <span class="material-symbols-rounded text-base">videocam</span> Join Now
                            </button>`;
                    }
                    // 3. Completed Session: Review (Only Learner)
                    else if (b.status === 'completed') {
                        if (!isTeacher) {
                            actionBtn = `
                                <button onclick="openReviewModal('${b._id}', '${b.teacherId}')" class="mt-4 w-full bg-yellow-400 text-yellow-900 py-3 rounded-xl text-xs font-bold shadow-lg shadow-yellow-400/20 hover:bg-yellow-300 transition-all flex justify-center items-center gap-2">
                                    <span class="material-symbols-rounded text-base filled">star</span> Write Review
                                </button>`;
                        } else {
                            actionBtn = `<div class="mt-4 w-full text-center text-green-500 bg-green-50 dark:bg-green-900/10 py-2 rounded-xl text-xs font-bold border border-green-100 dark:border-green-900/30">âœ“ Session Completed</div>`;
                        }
                    }
                    else if (b.status === 'cancelled') {
                        actionBtn = `<div class="mt-4 w-full text-center text-slate-400 text-xs font-bold py-2">Cancelled</div>`;
                    }

                    const cardHtml = `
                        <div class="bg-white dark:bg-dark-surface p-6 rounded-[24px] shadow-sm border border-slate-100 dark:border-white/5 hover:-translate-y-1 transition-transform duration-300">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">${b.date} â€¢ ${b.time}</span>
                                    <h3 class="font-bold text-lg text-slate-900 dark:text-white mt-1 leading-tight">${b.skill}</h3>
                                </div>
                                <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${statusStyle}">${b.status}</span>
                            </div>
                            
                            <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-white/5 rounded-2xl">
                                <div class="w-10 h-10 rounded-full bg-brand-50 dark:bg-brand-900/20 flex items-center justify-center text-brand-600 font-bold text-sm shrink-0">
                                    ${otherName.charAt(0)}
                                </div>
                                <div class="min-w-0">
                                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">${roleLabel}</p>
                                    <p class="text-sm font-bold text-slate-700 dark:text-slate-200 truncate">${otherName}</p>
                                </div>
                            </div>
                            ${actionBtn}
                        </div>
                    `;

                    if (isTeacher) teachingContainer.innerHTML += cardHtml;
                    else learningContainer.innerHTML += cardHtml;
                });

            } catch (err) { console.error(err); }
        }

        async function updateStatus(bookingId, newStatus) {
            if (!confirm(`Are you sure you want to ${newStatus} this session?`)) return;

            try {
                const res = await fetch(`http://127.0.0.1:5000/api/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await res.json();
                
                if (res.ok) {
                    Toastify({ text: `Session ${newStatus} âœ…`, style: { background: "#10b981" } }).showToast();
                    loadSessions(); 
                } else {
                    Toastify({ text: data.error || "Update Failed", style: { background: "#ef4444" } }).showToast();
                }
            } catch (e) {
                Toastify({ text: "Network Error", style: { background: "#ef4444" } }).showToast();
            }
        }

        function joinSession(bookingId, role) {
            localStorage.setItem('current_booking_id', bookingId);
            localStorage.setItem('current_user_role', role);
            window.location.href = 'live_session.html';
        }

        function switchTab(tab) {
            document.getElementById('learning-container').classList.add('hidden');
            document.getElementById('teaching-container').classList.add('hidden');
            
            const btnLearn = document.getElementById('tab-learning');
            const btnTeach = document.getElementById('tab-teaching');

            btnLearn.className = 'pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-bold text-sm transition-colors';
            btnTeach.className = 'pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-bold text-sm transition-colors';

            document.getElementById(`${tab}-container`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.className = 'pb-3 border-b-2 border-brand-600 text-brand-600 font-bold text-sm transition-colors';
        }

        function getStatusStyle(status) {
            if(status === 'confirmed' || status === 'ready' || status === 'ongoing') return 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400';
            if(status === 'pending') return 'bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400';
            if(status === 'cancelled') return 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400';
            if(status === 'completed') return 'bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400';
            return 'bg-slate-100 text-slate-500';
        }

        // --- REVIEW MODAL LOGIC ---
        function openReviewModal(bId, tId) {
            currentReview = { bookingId: bId, teacherId: tId, rating: 0 };
            document.getElementById('review-comment').value = '';
            rate(0); // Reset stars
            
            const modal = document.getElementById('review-modal');
            const content = document.getElementById('review-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeReviewModal() {
            const modal = document.getElementById('review-modal');
            const content = document.getElementById('review-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function rate(stars) {
            currentReview.rating = stars;
            const starBtns = document.querySelectorAll('.star-btn span');
            starBtns.forEach((btn, index) => {
                if (index < stars) {
                    btn.classList.add('filled', 'text-yellow-400');
                    btn.classList.remove('text-slate-300');
                } else {
                    btn.classList.remove('filled', 'text-yellow-400');
                    btn.classList.add('text-slate-300');
                }
            });
        }

        async function submitReview() {
            if (currentReview.rating === 0) {
                Toastify({ text: "Please select a rating! â­", style: { background: "#f59e0b" } }).showToast();
                return;
            }

            const comment = document.getElementById('review-comment').value;
            const btn = document.getElementById('submit-review-btn');
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                const res = await fetch('http://127.0.0.1:5000/api/reviews', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bookingId: currentReview.bookingId,
                        teacherId: currentReview.teacherId,
                        reviewerId: myId,
                        rating: currentReview.rating,
                        comment: comment
                    })
                });

                if (res.ok) {
                    Toastify({ text: "Review Submitted! ðŸŽ‰", style: { background: "#10b981" } }).showToast();
                    closeReviewModal();
                    // Optionally refresh list or hide button locally
                    loadSessions(); 
                } else {
                    Toastify({ text: "Submission Failed", style: { background: "#ef4444" } }).showToast();
                }
            } catch (e) {
                console.error(e);
                Toastify({ text: "Server Error", style: { background: "#ef4444" } }).showToast();
            } finally {
                btn.innerText = "Submit";
                btn.disabled = false;
            }
        }
        
        document.getElementById('logout-btn').onclick = () => { localStorage.clear(); window.location.href = 'login.html'; };
    </script>
</body>
</html>