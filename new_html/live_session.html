<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Live Session - SkillSwap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        iframe { border: none; width: 100%; height: 100%; }
    </style>
</head>
<body class="bg-gray-900 h-screen flex flex-col overflow-hidden text-white">

    <header class="h-16 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-6 z-10 shrink-0">
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-red-500 animate-pulse">radio_button_checked</span>
            <div>
                <h1 class="font-bold text-lg leading-tight">Live Session</h1>
                <p id="timer" class="text-xs text-gray-400 font-mono">00:00:00</p>
            </div>
        </div>
        
        <button onclick="endSession()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
            <span class="material-symbols-outlined text-[18px]">call_end</span>
            End Session
        </button>
    </header>

    <main class="flex-1 relative bg-black flex justify-center items-center">
        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center z-0">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-400 animate-pulse">Connecting to secure room...</p>
        </div>

        <iframe id="whereby-frame" allow="camera; microphone; fullscreen; speaker; display-capture" class="relative z-10"></iframe>
    </main>

    <script>
        let bookingId = null;
        let userRole = null;
        let sessionTimer = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            bookingId = localStorage.getItem('current_booking_id');
            userRole = localStorage.getItem('current_user_role'); // 'teacher' or 'learner'

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙˆÙ† Ø§Ù„Ø·Ø±Ø¯ Ø§Ù„ÙÙˆØ±ÙŠ
            if (!bookingId) {
                alert("âŒ Error: No session ID found. Returning to dashboard.");
                window.location.href = 'user_dashboard.html';
                return;
            }

            console.log("ðŸš€ Starting Session:", bookingId, "As:", userRole);
            await initializeSession();
            startTimer();
        });

        async function initializeSession() {
            try {
                // 2. Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡/ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                // Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø¬Ø§Ù‡Ø² ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ³
                await fetch(`http://127.0.0.1:5000/api/create-session/${bookingId}`, { method: 'POST' });

                // 3. Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¯ÙˆØ± (Ø§Ù„Ù…Ø¹Ù„Ù… HostØŒ Ø§Ù„Ø·Ø§Ù„Ø¨ Guest)
                const res = await fetch(`http://127.0.0.1:5000/api/get-meeting-link/${bookingId}?role=${userRole}`);
                const data = await res.json();

                if (data.url) {
                    // 4. ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù€ iframe
                    const iframe = document.getElementById('whereby-frame');
                    iframe.src = data.url;
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ iframe
                    iframe.onload = () => document.getElementById('loader').style.display = 'none';
                } else {
                    alert("âš ï¸ Room not ready: " + (data.error || "Unknown error"));
                    // Ù„Ø§ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø·Ø±Ø¯ Ù‡Ù†Ø§ØŒ Ø¨Ù„ Ù†ØªØ±Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ù‰ Ø§Ù„Ø®Ø·Ø£
                }

            } catch (err) {
                console.error("Session Error:", err);
                alert("Connection failed. Please check your internet.");
            }
        }

        async function endSession() {
            if(!confirm("Are you sure you want to end this session?")) return;

            // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡Ø§ Ø¥Ù„Ù‰ completed
            try {
                await fetch(`http://127.0.0.1:5000/api/bookings/${bookingId}/finish`, {
                    method: 'PUT'
                });
            } catch(e) { console.error(e); }

            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø±Ø¬ÙˆØ¹
            clearInterval(sessionTimer);
            window.location.href = 'my_sessions.html';
        }

        function startTimer() {
            let seconds = 0;
            sessionTimer = setInterval(() => {
                seconds++;
                const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
                const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
    </script>
</body>
</html>